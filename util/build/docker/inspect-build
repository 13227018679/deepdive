#!/usr/bin/env bash
# inspect-build -- Runs an interactive shell or given command inside a Docker
#                  container attached to the latest build
##
set -euo pipefail
. "$(dirname "$0")"/config.bash ''

DOCKER_CONTAINER+="-inspect.$$"

# docker run options
dockerRunOpts=(
    --rm
)

# run given command or shell depending on whether we're in a tty
if [[ -t 1 ]]; then
    # interactive shell in a tty
    [[ $# -gt 0 ]] || set -- bash -i
    dockerRunOpts+=(--interactive --tty)
else
    # just a shell
    [[ $# -gt 0 ]] || set -- bash
fi

# XXX need to wrap command around a script(1) session to get sane tty as well
# as a real PGID separate from 1
set -- script -q -e -c "$(printf "%q " exec "$@")" /dev/null

set -x
# run the command in a container
docker run --name "$DOCKER_CONTAINER" \
    "${dockerRunOpts[@]}" \
    "$DOCKER_IMAGE" \
    "$@"
