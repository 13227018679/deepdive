#!/usr/bin/env bash
# inspect-build -- Runs an interactive shell or given command inside a Docker
#                  container attached to the latest build
##
set -euo pipefail
. "$(dirname "$0")"/config.bash ''

DOCKER_CONTAINER+="-inspect.$$"

# run given command or shell
if [[ -t 1 ]]; then
    # in a tty
    [[ $# -gt 0 ]] || set -- bash -i
    cmd=$(printf "%q " exec "$@")
    set -x
    docker run --name "$DOCKER_CONTAINER" \
        --rm \
        --interactive --tty \
        "$DOCKER_IMAGE" \
        env \
            TERM="$TERM" \
        script -q -e -c "$cmd" /dev/null
else
    [[ $# -gt 0 ]] || set -- bash
    set -x
    docker run --name "$DOCKER_CONTAINER" \
        --rm \
        "$DOCKER_IMAGE" \
        "$@"
fi
